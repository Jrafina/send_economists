name: Daily Economist Download

on:
  push:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š9ç‚¹è¿è¡Œï¼ˆUTCæ—¶é—´1ç‚¹ï¼‰
    - cron: '0 1 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      test_email:
        description: 'æµ‹è¯•é‚®ç®±åœ°å€ï¼ˆå¯é€‰ï¼Œè¦†ç›–é»˜è®¤æŽ¥æ”¶é‚®ç®±ï¼‰'
        required: false

jobs:
  download-and-send:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests lxml
    
    - name: Download The Economist
      id: download
      run: |
        echo "å¼€å§‹ä¸‹è½½ The Economist..."
        echo "å½“å‰æ—¶é—´: $(date)"
        echo "å·¥ä½œç›®å½•: $(pwd)"
        
        python economist_crawler.py
        
        # æ£€æŸ¥æ˜¯å¦ä¸‹è½½æˆåŠŸ
        if ls The_Economist_*.pdf 1> /dev/null 2>&1; then
          echo "ä¸‹è½½æˆåŠŸ"
          PDF_FILE=$(ls The_Economist_*.pdf | head -1)
          echo "pdf_file=$PDF_FILE" >> $GITHUB_OUTPUT
          echo "success=true" >> $GITHUB_OUTPUT
        else
          echo "ä¸‹è½½å¤±è´¥ï¼Œæœªæ‰¾åˆ°PDFæ–‡ä»¶"
          echo "success=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Send email
      env:
        QQ_EMAIL: ${{ secrets.QQ_EMAIL }}
        QQ_EMAIL_AUTH_CODE: ${{ secrets.QQ_EMAIL_AUTH_CODE }}
        RECEIVER_EMAIL: ${{ secrets.RECEIVER_EMAIL }}
      run: |
        echo "å¼€å§‹å‘é€é‚®ä»¶..."
        
        # å¦‚æžœæ‰‹åŠ¨è§¦å‘æ—¶æä¾›äº†æµ‹è¯•é‚®ç®±ï¼Œåˆ™è¦†ç›–é»˜è®¤æŽ¥æ”¶é‚®ç®±
        if [ -n "${{ github.event.inputs.test_email }}" ]; then
          echo "ä½¿ç”¨æµ‹è¯•é‚®ç®±: ${{ github.event.inputs.test_email }}"
          export RECEIVER_EMAIL="${{ github.event.inputs.test_email }}"
        fi
        
        echo "å‘ä»¶äºº: $QQ_EMAIL"
        echo "æ”¶ä»¶äºº: $RECEIVER_EMAIL"
        
        # æŸ¥æ‰¾æœ€æ–°çš„PDFæ–‡ä»¶
        PDF_FILE=""
        if ls The_Economist_*.pdf 1> /dev/null 2>&1; then
          PDF_FILE=$(ls The_Economist_*.pdf | head -1)
          echo "æ‰¾åˆ°PDFæ–‡ä»¶: $PDF_FILE"
          python send_email.py "$PDF_FILE"
        else
          echo "æœªæ‰¾åˆ°PDFæ–‡ä»¶ï¼Œå‘é€å¤±è´¥é€šçŸ¥"
          python send_email.py
        fi
    
    - name: Upload PDF as artifact (for debugging)
      if: always() && steps.download.outputs.success == 'true'
      uses: actions/upload-artifact@v3
      with:
        name: economist-pdf
        path: The_Economist_*.pdf
    
    - name: Clean up
      if: always()
      run: |
        echo "æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
        rm -f The_Economist_*.pdf
    
    - name: Create summary
      if: always()
      run: |
        echo "## The Economist è‡ªåŠ¨ä¸‹è½½ä»»åŠ¡" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**æ‰§è¡Œæ—¶é—´:** $(date '+%Y-%m-%d %H:%M:%S') (UTC)" >> $GITHUB_STEP_SUMMARY
        echo "**çŠ¶æ€:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if ls The_Economist_*.pdf 1> /dev/null 2>&1; then
          PDF_FILE=$(ls The_Economist_*.pdf | head -1)
          FILE_SIZE=$(stat -c%s "$PDF_FILE" 2>/dev/null || stat -f%z "$PDF_FILE" 2>/dev/null)
          FILE_SIZE_MB=$(echo "scale=2; $FILE_SIZE / 1024 / 1024" | bc)
          
          echo "âœ… **ä¸‹è½½çŠ¶æ€:** æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“„ **æ–‡ä»¶:** $PDF_FILE" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ **å¤§å°:** ${FILE_SIZE_MB} MB" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“§ **é‚®ä»¶:** å·²å‘é€åˆ° ${{ secrets.RECEIVER_EMAIL }}" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **ä¸‹è½½çŠ¶æ€:** å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“§ **é‚®ä»¶:** å·²å‘é€å¤±è´¥é€šçŸ¥åˆ° ${{ secrets.RECEIVER_EMAIL }}" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*æ­¤ä»»åŠ¡ç”± GitHub Actions è‡ªåŠ¨æ‰§è¡Œ*" >> $GITHUB_STEP_SUMMARY
